{{ define "main" }}
<section class="post">
  <h1>{{ .Title }}</h1>
  <p class="date">{{ .Date.Format "January 2, 2006" }}</p>
  <article>
    {{ .Content }}
  </article>

  <hr>

  <h2>Comments</h2>
  <div id="commentsContainer">Loading comments...</div>

  <h3>Leave a Comment</h3>
  <form id="commentForm">
    <input name="name" placeholder="Your name" required><br>
    <textarea name="comment" placeholder="Your comment" required></textarea><br>
    <input type="hidden" name="post_slug" value="{{ .File.BaseFileName }}">
    <button type="submit">Submit</button>
  </form>
  <div id="commentStatus"></div>
</section>

<script>
  const slug = "{{ .File.BaseFileName }}";

  async function loadComments() {
    const res = await fetch(`/api/get-comments?post=${slug}`);
    const comments = await res.json();
    document.getElementById("commentsContainer").innerHTML =
      comments.map(c => `
        <div class="comment">
          <strong>${c.name}</strong> (${new Date(c.timestamp).toLocaleString()}):<br>
          ${c.comment}
        </div>
      `).join("<hr>");
  }

  document.getElementById("commentForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const form = e.target;
    const data = Object.fromEntries(new FormData(form).entries());

    const res = await fetch("/api/post-comment", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        // "x-api-key": "YOUR_KEY" // uncomment if you're requiring this
      },
      body: JSON.stringify(data)
    });

    const result = await res.text();
    document.getElementById("commentStatus").textContent = result;
    form.reset();
    loadComments(); // refresh comments after post
  });

  loadComments();
</script>
{{ end }}
