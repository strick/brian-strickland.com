{{ define "main" }}
<section class="post">
  <h1>{{ .Title }}</h1>
  <p class="date">{{ .Date.Format "January 2, 2006" }}</p>
  <article>
    {{ .Content }}
  </article>

  <hr>

  <h2>Comments</h2>
  <div id="commentsContainer">Loading comments...</div>

  <h3>Leave a Comment</h3>
  <form id="comment-form">
    <input type="text" name="name" required>
    <textarea name="comment" required></textarea>
    <input type="hidden" name="post_slug" value="{{ .Slug }}">

    <!-- Honeypot field -->
    <div style="display:none;">
      <label>Leave this field empty</label>
      <input type="text" name="website">
    </div>

    <button type="submit">Post Comment</button>
  </form>

  <div id="commentStatus"></div>
</section>

<script>
  const slug = "{{ .File.BaseFileName }}";

  function escapeHTML(str) {
    return str.replace(/[&<>"']/g, tag => (
      { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[tag]
    ));
  }

  async function loadComments() {
    const res = await fetch(`/api/get-comments?post=${slug}`);
    const comments = await res.json();
    document.getElementById("commentsContainer").innerHTML =
      comments.map(c => `
        <div class="comment">
          <strong>${escapeHTML(c.name)}</strong> (${new Date(c.timestamp).toLocaleString()}):<br>
          ${escapeHTML(c.comment)}
        </div>
      `).join("<hr>");
  }

  document.getElementById("comment-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const form = e.target;
    const data = Object.fromEntries(new FormData(form).entries());

    const res = await fetch("/api/post-comment", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "x-api-key": "YOUR_KEY"
      },
      body: JSON.stringify(data)
    });

    const result = await res.text();
    document.getElementById("commentStatus").textContent = result;
    form.reset();
    loadComments();
  });

  loadComments();
</script>
{{ end }}
